# 性能测试

## 思维差异

- 功能测试、自动化测试
  - 输出： 找bug  预期结果与实际结果进行比较
  - 隐藏的前提：模拟都是1个用户的操作

  + 性能测试
    + 不是模拟1个人，**模拟多个人同时**，
    + 关注==>多个人操作时，响应时间，
    + 接口服务器性能测试中，一定是多个人同时操作，才是性能测试

## 性能测试概念

100个人同时登录接口进行登录，性能中的`avgRT(平均响应时间)`应该在多少，是可以被接受的？

- 可接受的范围 1.5s，常规说的2-5-8为域名的响应时间
- 1.5s APDEX 用户满意度指数

事务：一个请求行为，并不一定只有一个接口，所以，一个事务可能是多个接口。

- jmeter：默认情况下，1个接口请求一次，认为一个1个事务`Transation`
  - 也可以是通过事务控制器，挂载多个接口请求，合并成为1个事务
- 是从发起，到网络传输，收到响应

## 什么是性能测试

性能：事务、物品的某些特征的评价值

## 性能测试

- 通过工具，模拟多用户发起请求，获取**性能指标值**
  - 用工具来模拟多个人的方式很多
    - 进程： 资源拥有者，创造进程消耗的是CPU、和内存。资源消耗会比较大。LR
      - 进程+ 线程： ngrinder
      - 协程： python+locust
    - 线程:  使用进程的资源，来干。jmeter、lr

## 性能指标

- `avgRT`	平均响应时间	90%
- `TPS`        服务器每秒处理的事务数
  - **衡量服务器处理能力**的最重要的指标
- 吞吐量：**网络**中每秒传输的事务数
  - **没有网络瓶颈**：tps 数值 = 吞吐量数值
  - **如果网络有瓶颈**: tps 数值 != 吞吐量数值
- 吞吐率  每秒钟能通过多少kb数据
- 服务器资源利用率
  - cpu、内存、io的利用率
- 并发用户数：
  - 同一时间发起请求 用户数
    + 广义并发： 同一时间发起请求(相同、不相同)
    + 狭义并发：同一时间发起相同请求
         + 集合点：集合多个人在同一时间发起相同请求
  - 并发用数100   发起请求，一秒钟会发起多少请求？（请求的频率）不知道，所以1秒钟总请求量，不知道，

## 负载测试

- **逐步增加**并发用户数，测试系统性能变化，找出最大 拐点区间
  -  逐步增加并发用户数，
  -  区间怎么判断
    - 有没有报错
    - tps下降
    - 响应时间变长

50tps： 服务器每秒能处理50个事务

50 t/s  * 60 * 60 = 18w     300tps

假设一天为8h：18w  * 8h  = 144w

耗时：一般测试都是几分钟，十几分钟

### 压力测试

使用一定量的并发用户数，持续运行一个较长时间，看系统服务以及各资源利用情况稳定性，一般以小时为单位7*24小时。

- 一定量：访问 小于最大并发用户数	20% 或者 80%  MaxThreads

## 性能测试

性能测试：通过工具，模拟一定量的并发用户数，向服务器发起请求，获得我们性能指标

- 通过进行负载测试，得到最大并发用户数的拐点，在服务器进行性能测试，得到当前平均响应时间、资源利用率的数据进行性能测试报告

耗时：一般都是几分钟

## 常见性能指标

TPS:  **服务器**每秒处理事务数   服务器的综合处理能力

吞吐量：**网络**每秒能通过的事务

rps： 请求，每秒**用户**请求率     **发起方**，用户每秒能够发起的请求

qps： 每秒查询率， **服务器**的查询

- 在企业中，如果没有严格区分，是把1个事务，当做只查询1次，但，实际请求可能是 1事务: n个查询

hps：hit per seconds  每秒**用户**点击率  页面点击

## 容量测试

在一定的软、硬件条件下，在数据库不同数量级数据量的情况下，对系统中读\写比较多的业务进行测试，从而获得不同数据量级下的性能指标值

在性能测试时，如果数据库的数据量级是不一致的，性能指标值，也可能存在差异。 **在做性能测试时，数据库的数据量级一定要保证一致。**

生成的数据库数据量级  百万级

测试用的环境，独立性能测试环境， 不超过万

性能测试，不能使用功能测试环境、自动化测试环境、验收、生成环境都不能用。需要自己搭建独立环境

自己搭建：

独立环境：真正的性能测试环境，机器资源配置是和生产完全一样（硬件配置一样、数量一样、网络一样、架构参数一样）

网络：网络架构，网络基础，性能测试，不能使用无线网络，也不要去使用vpn等桥连，尽可能使用局域网

- 不使用无线网络，是因为网络不稳定，会导致阻塞
- 不是用VPN是因为不安全

## 性能测试的前提

+ 性能测试并不是想做就做？

  + 核心的业务，用户量最大优先

  可测性：反复沟通确定性能指标

+ 性能测试流程
  +  性能测试准备
     +  需求分析
     +  明确性能测试目标(指标值)
     +  了解软件功能、架构
     +  指定测试计划、做好工作量评估
     +  制定 测试模型(编辑测试用例)
  +  搭建性能测试环境
     +  工具选型与准备
     +  被测系统环境搭建(服务器、服务版本更新、**数据库数据准备**(数据量级))
     +  网络配置
  +  性能测试脚本开发
     +  选取协议
     +  制作脚本
     +  调试脚本
     +  验证脚本
  +  性能测试脚本执行
     +  试运行
     +  场景执行
  +  结果分析与调优
     +  分析数据：结果图表
     +  分析思路：服务器硬件瓶颈>网络瓶颈>服务器os瓶颈(参数配置、数据库、WEB服务器)>应用瓶颈(SQL语句、数据库设计、业务逻辑、算法)
     +  调优
     +  修改脚本或场景
  +  测试报告与结果跟踪
     +  性能测试报告
     +  性能测试问题跟踪

### 必要性研究--关键项评估

- 主管部门、监管部门审查--12306
- 涉及生命财产安全--银行系统
- 大型新系统
- 核心系统
- 架构调整
- 业务剧增
- 重大缺陷修复

### 可测性--可量化为性能指标值

![img](https://img-blog.csdnimg.cn/201c10e205724defbf22f8225343cfe9.png)

# 性能测试需要的知识面

## 服务器的发展

- 台式机--->刀片机

- vmare虚拟技术：vmare
  - 虚拟出操作系统
    - 1个刀片机安装一个操作系统之后，可以虚拟出N多个操作系统
    - 1:N操作系统
  - 1个刀片机   n个刀片机
  - 08-15年左右，企业中服务器为虚拟机非常流向
  - 用vmware 虚拟技术虚拟的操作系统，是非常消耗本机的硬件资源
  - 用vmware虚拟技术虚拟的机器，能产生多个操作系统，更大化使用本机资源，但是，vmware也非常消耗资源，会使用大量的磁盘空间和cpu、内存资源。它对我们本机的性能是有影响，但是因为虚拟了多个操作系统，可以更大化利用空间。
- 云服务器
  - 也是虚拟技术发展的产品，虚拟操作系统（比较完整的操作系统）
- docker
        + 也是linux操作系统，定制化， 缩减版的操作系统(namespace、unionFS、cgroup)

### 应用发展

+ os系统： linux（常用命令）
  + 常用命令
  + 配置环境变量
  + 防火墙、网络
  + linux的性能分析命令（top、ps、netstat、）
+ cpu
+ OOM
+ jvm    前面这些内容，快速浏览，暂时不要深入研究

## 应用的发展

+ 应用的发展
  + 最开始，所有的代码都在一个工程下面，生成一个项目包，随着项目开发，代码越来越多，要运行这个工程的硬件资源配置就要越来越高
  + 然后，就是拆项目和数据库Oracle sqlserver access  mysql  postgresql、文件服务ftp、oss器、 项目服务器apache、tomcat、springboot、 springcloud、docker 、集群nginx
  + 数据库： 主从、非关系型（mongodb、memcache(缓存数据库--基本淘汰)、redis）、时序数据库(influxdb\ prometheus)
  + 拆项目：前 后端（最初）中台， 后台逐步模块化，微服务

# 环境搭建

ova文件

	vmware + 操作系统iso ===导出  ova文件   开机即可使用

安装vmware软件、virtualbox： 一定要记得 重启动电脑

	查看‘网络连接’   里面一定要有  vmnet8  必须是启用

Vmware工具，可以在windows、linux、mac中安装( 版本可以是12以上都可以)

vmware   file > 打开 找到ova文件  填写名称，选择路径(不要使用默认的c盘路径)

第一次会报错，没有关系，点击 重试

+ 导入成功之后： 编辑虚拟机设置

  + 根据自己的机器配置，修改 内存大小，cpu的数量
  + 网络适配器，vmware一定要选择  NAT 网络   virtualbox选择桥接网络

**具体安装方法会详细开一篇文章文章编写**

+ 启动机器：

  + 第1件事情： 登录用户

  + 第2件事情： **执行  ifconfig   登录后，稍微等5秒钟左右**

    + ifconfig   查看ip信息

    + 看到网卡名称为  ens33 的  inet  就是机器ip地址

      + 192.168.114.140
      + 这个时候，你本机和这个项目机器是一个局域网
      + 和你公司其他人员的电脑，不在一个局域网
  + 第3件事情：启动项目

    + cd /opt/apache-tomcat-8.5.56/bin
      + 可以写  开头字母+tab键
    + ./startup.sh       ./st按下tab键
+ 使用远程连接客户端工具
  + xshell   crt、finalshell、putty、dos终端

# 工具安装

## Jmeter

+ 安装jmeter

  + Apache 托管的开源java工具
  + 接口测试、自动化测试、性能测试
  + java要运行依赖什么？
    + jre   java 运行环境
    + jdk  java开发工具包，一般是包含jre
    + 我们课程中，除了kyj项目是jdk1.7   其余所有地方用到jdk的都是1.8
  + 查看jdk版本
    + `java -version`  正常返回jdk版本，但是不代表你的系统就配置JAVA_HOME环境变量
    + JAVA_HOME

![img](https://img-blog.csdnimg.cn/a2eeb8e12e3545deaa171ee26c4306f8.png)

+ jmeter安装

  + 下载安装Jmeter ：https://jmeter.apache.org/download_jmeter.cgi
  + 解压zip包，进入解压后文件夹\bin文件夹中，双击 jmeter.bat，启动图形界面GUI
    + mac    ./jmeter.sh
  + 上课用jmeter版本是5.1.1  
  + 1、不需要大家配置**JMETER_HOME环境变量**

    + 原因： 如果配置了，那么你的电脑就有且仅能运行一个jmeter
    + 配置环境变量，可能会导致，直接闪退
      + 直接闪退原因：
        + 配置了环境变量
        + 没有安装jdk
        + 包少了文件
        
          ```python 
          Error: Unable to access jarfile ./ApacheJMeter.jar
          ```
  + 2、一台电脑，理论上可以启动任意多个不同版本jmeter
  + jmeter设置语言：
    + jmeter.properties
      + 以.properties结尾的文件，都是jmeter的**属性**配置文件
      + 最关键的 属性 配置文件   jmeter.properties
        + 修改**属性配置文件**中的信息，一定要重启才能生效
        + 
    + gui中   options  > choose language > chinese simplied
      + 临时切换gui界面语言
      + 一旦关闭gui，就会被还原

## 文件路径：

+ bin  启动 配置文件
+ lib   jar包  工具自身jar， 以及第三方jar
  + ext   第三方插件管理
+ docs   文档  用于jmeter进行二次开发调用的api  接口文档
+ printable_docs   离线帮助文档
+ extras  扩展   CICD 性能测试持续集成

## gui界面

+  一切都在**右键**掌握之中
+ 测试计划：   工作中测试计划： 什么时间什么人做什么事情
  + 万物的根， 脚本的根文件，根结点
  + 元件
    + 线程组： 接口、自动化测试时，基本不会去改动
      + 性能测试，这个是用于**进行性能场景设计**的
      + 线程组：进行性能场景设计 
      + setup线程组
      + teardown线程组
    + 配置元件
      + 优先级是最高的， 正式干活时，急先锋
      + **用户定义变量**--最先被执行
    + 监听器
      + 就是侦探 就是摄像头，性能结果进行监控，展示结果数据
      + 不同的元件，是从不同的角度，展示结果数据
    + 取样器： 根据不同的协议，使用不同的取样器**编写脚本**
    + 逻辑控制：
    + 前置：
      + **用户参数**
    + 后置： 对 取样器进行控制
    + 定时器

## 接口文档

接口文档： 用户使用易捷支付平台的  接口文档    不是管理人员的接口问题。ToC

# Jmeter写脚本

jmeter写脚本

  + 万能法
    + 先把项目启动
    + 打开我们项目接口文档
      + 接口文档： 一般是开发
    + 特别注意事项：
      + 当你的接口请求参数为json格式时，**一定**要写请求头，请求头中**一定**要有 Content-Type： application/json
      + 如果没有这个信息，100%报错，不局限于jmeter
      + 衍生： http**请求**包括哪些部分
        + 请求行
          + 请求方法，请求地址URI
        + 请求头
          + Content-Type
          + cookie
          + User-Agent
        + 空一行
        + 请求体
          + 参数：  表单
          + 消息体数据： json 、xml
    + json格式：
    
      + {"key":"value","key1":1} 
    + 开发人员接口中定义的返回码code，和http response_code不一样
    
      + http response_code： 
        + 2xx：  网络请求超过 200
        + 3xx： 重定向相关 301
        + 4xx： 请求URL地址有问题 400 404
        + 5xx：服务器内部异常 500、502bad gatway

- **声明：** 我们的项目接口地址URI中只有一层/app

## 写脚本

+ **写脚本**
  + 测试计划上右键， 添加  **线程组**
  + 线程组上右键，添加  **取样器**> http请求   （http协议簇）
  + 线程组上右键，添加 监听器 > **查看结果树**

一个最简单的jmeter脚本，包括，线程组、取样器、监听器

- 线程组： 性能测试中用于场景设计的，写脚本阶段不用改动

- 取样器： 根据不同的协议，编写不同的脚本。 填空

- 监听器： 调试脚本时使用，**性能测试执行时**，**禁用**
  - 不管哪种监听器，都是对结果数据进行不同维度的展示，这些展示，是需要消耗本地资源的

8080端口，是tomcat的默认端口

http协议的默认端口：80

https协议默认端口: 443

- jmeter的默认保存路径，jmeter的bin文件夹

![img](https://img-blog.csdnimg.cn/a4e7297cfcae4c58abef25da2111aaf3.png)

**请注意：**

1、当请求体为json， 一定要有请求头 Content-Type：application/json

2、json格式有问题

3、协议： 当协议为http时，可以不写，如果是**https**，那就必须写

4、服务器名称或IP：不能带有/

5、路径： 不要带域名或ip，和端口

	路径开头，用/
	
	不要带有空格， 带有空格请求URL  %20    urlencoded编码
	
	URI  资源地址
	
	URL： 带domain

6、内容编码：utf8

	请求内容出现乱码处理方法：
	
		1、内容编码： utf8
	
		2、请求头，;charset=utf-8
	
		3、请求体为**参数**类型：勾选参数“编码”  编码：urlencoded编码
	
				在参数值为 非字符(**汉字、特殊符号**)  都需要勾选编码
	
				给大家的建议： 参数值，不管什么类型，都建议勾选编码
	
	**响应内容出现乱码**处理方法：
	
		需求修改jmeter.properties中sampler.result.encoding 
	
		不是简单的设置为utf8、 gbk、gb2312、big5
	
		同一个接口，用postmen请求，响应是正常，用jmeter请求响应中文乱码？原因是： jmeter的编码是根据操作系统编码。
	
	在国内，中文windows系统的字符集编码是gbk 936， mac系统中文编码utf8

7、参数、消息体数量  选择

	当我们的请求接口文档中说，请求体为json格式，那么我们就选择用消息体数据，来写json，   soap=http+xml
	
	参数： 我们的请求体，form-data   
	
		Content-Type: application/x-www-form-urlencoded 或者不指明请求体类型，get

8、自动重定向：不会显示中间重定向过程，无法从过程中，提取信息

	跟随重定向：会自动显示重定向过程，**能从过程中**，提取想要信息，用于后面接口请求

使用keepAlive：保持连接， 长连接，

因为现在用http协议版本为1.1 就是长连接，所以，默认勾选keepAlive，但是在性能测试中，我们会根据需要，去掉这个勾。

- 短连接：每个HTTP请求/响应都会使用一个单独的TCP连接。在完成请求/响应后，连接会立即关闭。这意味着每次请求/响应都需要建立和关闭连接，存在一定的开销。

- 长连接：在一个TCP连接上可以发送多个HTTP请求/响应。在一个请求/响应完成后，连接并不会立即关闭，而是保持打开状态，可以继续用于后续的请求/响应。通过长连接，可以减少因频繁建立和关闭连接而产生的开销，提高性能效率。

- 对于长连接，HTTP协议中使用了一些机制来管理连接的状态：

  - Connection头字段：客户端可以在请求头中添加`Connection: keep-alive`来指示服务器保持连接打开，或者`Connection: close`来指示服务器在响应后关闭连接。
  - Keep-Alive头字段：服务器可以在响应头中添加`Keep-Alive: timeout=max, max=total`来指示客户端保持连接打开的时间和最大请求数。

  断开连接的时机取决于具体的情况：

  - 在短连接中，连接会在每次请求/响应结束后立即关闭。
  - 在长连接中，如果客户端或服务器端明确要求关闭连接（通过Connection头字段或其他手段），或者达到了指定的时间或请求数限制，连接会被关闭。

  需要注意的是，长连接并不意味着永久保持连接，连接的生命周期仍受到各种因素的影响。服务器可能会在一段时间后主动关闭空闲连接，或者客户端可能会在某些条件下关闭连接。

# 新内容

## 如果没有接口文档

- 抓包： F12  、fiddler、wireshark、Charles
- 第三接口：api接口
-  swagger： 

## 写脚本方法扩展

+ 写脚本方法扩展---录制脚本：

+ badboy： 曾经很流行，现在已经不维护，已经被遗弃--只支持windows

+ 代理录制：  用于脚本参数比较多，或者用手动编写脚本，一时半会写不出来。

  + 代理服务器： 自己启动一个代理服务器
  + 本地，要使用代理服务器的ip和端口，使用自己启动的代理服务器

  + 1、添加线程组
  + 2、测试计划 > 非测试元件 > http代理服务器
    + ip就是你自己电脑的ip，port是可以修改，默认8888
    + 目标控制器，**一定要修改   修改为**  测试计划>线程组
    + 添加过滤器
  + 3、启动代理服务器时，会出现一个证书的弹窗(证书有效期为7天)
    + 如果要抓取https信息时，就必须使用证书 
  + 4、本地浏览器使用 代理服务器上网

  ![img](https://img-blog.csdnimg.cn/52907b2eefe94b4ea6093bed80447151.png)

![img](https://img-blog.csdnimg.cn/9606ee5052cb46209e08508e13e2ab45.png)

![img](https://img-blog.csdnimg.cn/0fdc5d461e2a47fd809868effb4e6f4e.png)

![img](https://img-blog.csdnimg.cn/32a1dca6742a45e6bcc379824ade131b.png)

## 脚本增强

+ 关联： 前面接口的响应信息，有动态值，作为后续接口的参数参数
+ 我想把手机号码，发生变化：
  + 变量： 用户定义变量，用户参数
  + **用户定义变量**:
    + 配置元件、测试计划
    + **全局变量**： 
      + 作用域：作用于整个‘**测试计划**’
    + <font color="red">在启动运行时，获取一次值，在运行过程中，不会动态获取值，在运行过程中，值一直都不变。</font>
  + **用户参数**:
    + 前置处理器
    + **局部变量**
      + 作用域： 作用于当前线程组或当前的取样器
    + <font color="red">在启动运行时，获取一次值，在运行过程中，还会动态获取值。</font>

+ 定义用户变量
  + var_user: 1888888888
    + 引用变量： ${var_user}

## Jmeter函数

jmeter的函数： 方法

1888888${__Random(1000,9999,)}： 字符串的连接

使用用户定义变量，设置5循环  register + login： 1次register-success   5次login-success

使用用户参数，设置5循环  register + login：  5次register-success   0次login-success

迭代： 一个线程组下所有的接口，全部执行完1次，才算1个迭代

+ 用户参数
  + 每次迭代更新一次

+ 函数：方法
  + 双下划线开头
  + 函数名称，严格区分大小写
  + 重要的函数
    + ${__counter(,)} 计数器
    + ${__dateTimeConvert(,,,)}   时间格式转换
    + ${__digest(,,,,)}  **加密**  简单加密
    + ${__intSum(,,)}  整数相加函数
    + ${__P(,)}   **获取属性函数**
    + ${__property(,,)}  **获取属性函数**
    + ${__setProperty(,,)}   设置**属性函数**
    + ${__Random(,,)}
    + ${__RandomString(,,)}
    + ${__threadNum}  获取线程号函数
    + ${__time(,)}  获取**当前时间戳函数**
    + ${__timeShift(,,,,)}  数据格式化
    + ${__V(,)}   **拼接**函数 

```python 
20210531
```

# 新内容

## 课程回顾

+ 用户定义变量 vs 用户参数
  + **用户定义变量**
    + 全局变量：  可以跨线程组
    + 在启动时，获取一次值，在运行过程中不会动态获取值
  + **用户参数**
    + 局部变量： 不能**直接**跨线程组
    + 在启动时，获取一次值，在运行过程中，还会动态获取值
  + 作为功能测试、自动化测试，非性能测试时，可以把接口写在一个**线程组**下面
  + 在性能测试时，可能会因为不同的需求，把接口写到不同的**线程组**中
    + 在性能测试中，多线程组脚本，有个难题，跨线程组传参
    + 我们采用“**用户属性**”
    + 函数

## 函数

+ 函数：
  + 查看，帮助、Random
  + jmeter中的函数： 可以被直接调用的方法
  + 使用函数的注意事项：要特别注意，**函数名称的大小写**

+ 重要的函数
  + ${__counter(,)} 计数器
    + 加1功能
    + 如果要 加2 ===计数器元件
      + 重点：最大值， 如果运行结果超过最大值时，又会从起始值开始循环
      + 每个用户独立计数器： 多线程时，每个用户都是从起始值开始计数
  + ${__dateTimeConvert(,,,)}   时间格式转换
  + ${__time(,)}  获取**当前时间戳函数**
    + 当前的时间
    + 格式化时间 YMD、yyyy-MM-dd
  + ${__timeShift(,,,,)}  数据格式化
  + ${__RandomDate(,,,,)}  随机日期
    + 不包括结束日期
  + ${__Random(,,)}
  + ${__RandomString(,,)}
  + ${__digest(,,,,)}  **加密**  简单加密
  + ${__intSum(,,)}  整数相加函数
  + ${__P(,)}   **获取属性函数**
    + ${__property(,,)}  **获取属性函数**
      + P 只是property这个函数的简写
    + ${__setProperty(,,)}   设置**属性函数**
      + 设置jmeter的动态属性,设置以后可以跨线程组使用属性
    + ${__V(,)}   **拼接**函数 

 属性： 以.properties结尾的文件，都是jmeter的属性配置文件
  + 属性是什么？是jmeter**工具自身**带有的标签。
  + jmeter工具属性：
    + jmeter属性：可能被改变
      + 静态属性： 写在properties文件中属性信息，都是静态属性
      + 动态属性：运行过程中，动态定义属性
    + 系统属性： os、jdk  ===这个系统属性信息，**是不可改变**
  + 属性  vs 参数 \ 变量  区别
    + 属性是jmeter工具具有，所有，jmeter中的线程组要使用属性，都可以使用
    + 参数、变量，有局限访问

+ 动态属性：一直存在？还是朝生夕死？
  + 动态属性，是在运行过程中产生的，关闭jmeter，就是自动释放了。
+ 顺序?
  + jmeter中，多个启用线程组，在执行时，**默认是并行执行**
  + 在**性能测试中**，我们**不会勾选**  测试计划中 “独立运行每个线程组”
    + 混合场景设计

======

${__V(,)}   **拼接**函数 

# 20210604白板

+ 属性
  + jmeter的属性，是jmeter工具自身的标签
  + 属性： 
    + jmeter属性：
      + 静态属性： propertites文件中
      + 动态属性： setProperty 函数进行设置， P  porperties 函数获取属性
    + 系统属性： 不可改变

jmeter中，做功能测试、自动化测试时，你可以使用 Beanshell元件，

但是，在**性能测试**中，能不用，坚决不要用带有任何Beanshell。

如果你要写java脚本，也不要使用Beanshell任何元件（这个插件非常消耗资源），可以使用JSR223 开头元件

jmeter可以支持： java、jython、python（不支持python3）、groovy、js。

+ V函数， 拼接函数：
  + $${var_${__counter(,)}}  -----我们**期望**它得到过程是${var_1}  ${var_2} ${var_3}   最终的结果是**变量的值**   实际是要进行两次变量计算 
    + =====这个方法是办不到，得不到我们的结果。

+ ${\_\_V(var\_${\_\_counter(,)},)}

+ 只能嵌套一层，

类似： var_1  var_2  前缀相同，后缀是递增数字的变量名称，常见于 jdbc从数据库中获取数据时。

select name from table where id like '123%';  ---结果可能有多条数据

这个脚本就会返回多个name值， 我用table_name这个变量来接收值，table_name_1,table_name_2...........

${变量名称}  ===得到变量的值

${\_\_V(前缀\_可变后缀)}   ========  得到是这个 “前缀_可变后缀” 变量名值

${__P(属性名称)}   ====得到的是 属性名称的值

---

**特别注意事项**：

1、查看结果树中，<font color="green">绿色</font>只是代表网络成功，不代表结果是否准确； <font color="red">红色</font>，代表失败，失败的原因有千万，具体是那种，需要具体排查

2、查看结果树为红色，不要只截图 取样器结果 

	需要截图： request-body   + request headers， response-body

3、**最重要点**： 查看结果树中的显示顺序是，根据<font color="red">**收到响应的先后顺序**</font>显示

jmeter中**取样器的执行顺序**：在没有逻辑控制器控制时，顺序是**从上往下**，不管多少人并发，每个线程用户都是从上往下执行。

会出现  取样器的执行顺序与 查看结果树中的显示顺序不一致。





+ 响应提取：  response提取
  + json提取器
    + 当确定响应信息为json格式时，我们**优先**选择用 json提取器提取我们响应的信息
    + $.根路径.二级路径    json提取式   ----绝对路径写法
    + $..末梢节点名称    -----相对路径写法， **推荐**
    + 在取样器上右键 > 后置处理器 > json提取器
      + json中的key-value键值对顺序是无序
    + **重点：**
      + $..
        + 一个json提取器写多个提取式，在jmeter中json提取器中使用`;`
  + 正则提取器
    + 正则提取式：    左边界(正则式)右边界   万能正则式： .*?
      + 除换行符之外，都可以匹配

# 20210607白板

+ 后置处理器

  + json提取器
    + 如果你的**响应体**为json格式，那么优先选用json提取器
    + 如果想要提前请求中内容、响应的头部内容、或者响应体格式非json格式，这些使用 优先选择 **正则提取器**
    + json提取式：
      + $.节点名称.二级节点名称    ----- 绝对路径
      + $..末梢节点名称   -------相对路径(**推荐**)
      + 一个json提取器写多个json提取式
        + 用 英文分号  ;
        + 此时，**一定要写**  默认值(default value)

  + 正则提取器：
    + 写正则式： 左边界(正则式)右边界
      + 万能正则式： .*?  ====除换行符不能匹配，其他都能匹配
    + .   匹配除换行符以外的所有字符
    + \* 匹配0次或多次——贪婪
    + \+ 匹配1次或多次——懒惰
    + ?  匹配0次或1次
    + \d   [0-9]  匹配数字
    + \w  [a-zA-Z0-9_] 字母和数字
    + 正则表达式中 []{}
    + 正则可以用于日常日志、文本中查找  perl
    + 一个正则提取器，写多个正则提取式：
      + 分隔符用 (.*?)

+ **关联**：
  + 前面接口的**动态数据**信息，提取出来，作为后面接口的传入参数
  + 当接口，使用cookie来管理信息时，请使用cookie管理器，而且，**第一次使用时，不要去修改任何cookie管理器信息**。
    + 只要使用到登录接口，以及登录之后才能使用的接口，就添加cookie管理器。不管你的项目是否使用cookie。
    + 使用默认的cookie管理器，先不要去配置如何信息。

# Jmeter作用域

![img](https://img-blog.csdnimg.cn/ce634902dd2043cfa20f2768785b28ce.png)



## DDT数据驱动性能测试 (一)

+ 性能测试，因为要使用多用户并发，请求的时间也要几分钟到几十分钟，所以总请求量，可能会很大。
  + 准备测试数据
    + 测试数据文件
+ 最典型的应用： 使用一批测试账号登录
  + 把一批测试账号，放在一个**纯文本文件**中管理。
    + 文本文件：txt，csv，json，xml，yml，dat(lr中管理数据文件)
+ csv数据文件设置：  
  + 支持的文件： 文本文件， 不局限于 txt\csv
  + 配置元件
  + **注意事项**：
    + 1、文件名称：可以是txt、csv等文本文件，都可以，但是，**我们推荐使用txt，能不用csv，就不用csv**。
      + 获取速度 txt相对要快
      + 编码：txt文件，默认编码，utf8； csv文件，默认编码，不是utf8
        + 因为csv文件，默认不是utf8格式，使用，在文件中包含中文时，使用其中的数据，会出现中文乱码。
        + 如果工作中，看到jmeter读取csv文件内容，乱码。
          + 原因：csv的编码不是utf8，而csv数据文件设置中，选择了utf8，导致编码不一致。
          + **解决**：把csv文件，用记事本打开，选择编码为utf8保存
      + 默认使用的是绝对路径，当路径出错时，会导致整个线程组，都不执行。
        + 解决？
          + 相对路径：
            + 相对点： 默认是jmeter的bin文件夹，也可以是jmeter脚本的保存路径。
            + 写法：（推荐）./ 开头 根上相对路径  -----这种写法可以支持跨平台
      + 用csv来准备数据，能用csv数据文件设置时，**坚决不用** ${__CSVRead(,)}函数。

# 20210609白板

+ csv数据文件设置   DDT数据驱动性能测试(一)
  + 到今天，基本脚本如何写
  + 1、文件名：
    + 绝对路径
    + 相对路径 ====推荐 ./ 开头  相对地址默认  jmeter的bin
      + 也可以以脚本保存的路径作为 **相对起始点**
      + 建议，大家把 jmx 与 数据文件   放在同一个路径下
      + 如果csv文件路径出错， 导致 单前整个线程组，不会运行
      + 文件，尽可能使用txt格式，能不用csv的，就不用
        + 使用csv文件，要特别注意：编码
  + 2、变量名称： 可以写多个，多个之间用“，” 固定使用逗号
  + 分隔符,与变量名称无关
  
  ![img](https://img-blog.csdnimg.cn/3288011374b34561895603f50d15a3bd.png)
  
  + 3、是否允许带引号：  **一对英文双引号** 
  + 4、 遇到文件结束符再次循环
    + true： 运行次数超过总数量行数时，会从头开始取值
    + False：运行次数超过总数量行数时，还会继续运行，但是取不到值
    + 管理**取值**的情况，必须得是英文的双引号
  + 5、 遇到文件结束符停止线程
    + 管理**运行状态**
  
+ 使用csv数据文件设置，默认配置的情况下，

![img](https://img-blog.csdnimg.cn/5e11daab6c9c4589ab923a81b71734da.png)

+ 当多用并发时，
  + 第1th，第一次取值，取第1行，
  + 第2th，第一次取值，取第2行
  + 第3th，第一次取值，取第3行

DDT数据驱动性能测试(二)



DDT数据驱动性能测试(三)





+ kyj 易捷支付项目

性能测试脚本中，会使用逻辑控制器，但是，使用了逻辑控制器，并不是混合场景。

混合场景，是 不同数量的并发用户，发起不同接口请求。

+ 逻辑控制器
  + 循环控制器
    + **常用在** 重复运行多次
  + foreach控制器
    + **常用于**，使用 带有 _ 下滑线变量引用
    +  python   
      + for x in []     给你一个西瓜，西瓜已经被切分为多股
        + foreach控制
      + for x in range()   给你一个西瓜，但是，不切成
        + 循环控制

var_1   var_2  var_3  var_4

${f}

+ if 条件控制：
  + 默认的情况下， 条件框中，要使用 \_\_jexl3  or \_\_groovy 函数的**计算结果**为true False
    + ----- 直接告诉你结果为真或假
  + 如果不勾选 Interpret condition as variable express   是把 条件框中的 **表达式** 当做js脚本，进行计算，计算的结果为真，则执行下面请求
    + ----是要你自己去算，算出来是真或假



+ 事务控制器

# 20210616白板

+ 逻辑控制 ------ jmeter脚本性能转换
+ 用jmeter写脚本，可以去做接口测试、自动化测试、性能测试
  + 但是，*接口测试、自动化测试脚本，<u>不能直接用于性能测试</u>*，需要进行性能转换，才能用于性能测试
  + 性能测试脚本，可以直接用于接口测试、自动化测试。
    + 性能测试，要尽可能的降低jmeter**工具自身**对资源消耗
      + 接口测试、自动化测试脚本，一定会添加**断言**，断言的目的是判断，是否有bug，断言这个元件在执行时，资源消耗，来自jmeter工具的资源，这个时间和资源的消耗，都是本机的，不是服务器消耗的时间和资源。-----我个人观点里面，是不要加断言。
      + Beanshell元件，写脚本时，只考虑功能能实现即可，不会过多去考虑，元件使用的时间、资源消耗。 
        + 性能测试中， Beanshell所有元件，能不用则不用，如果，一定要写java代码来处理的 JSR223、${\_\_jexl3(,)}、${\_\_groovy(,)}
        + 元件的选择：
          + JSR223
          + DDT
        + 运行模式:   GUI 图形界面模式，===只用于编辑调试脚本
          + 真正性能测试用  CLI模式  ---无图形界面模式
+ 循环控制
+ foreach控制
+ if条件控制
  + 默认勾选： Interpret condition as variable
    + 条件框中的，**结果**为true、false,要使用jexl3 和 groovy直接得出结果
  + 不勾选：Interpret condition as variable
    + 条件框中， 运算过程(表达式)的结果为true、false

# 事务控制器：

+ 在jmeter中，默认一个取样器，就是一个事务
+ 事务控制器，控制其子集取样器(n)，合并为一个事务
  + 事务： TPS    服务器每秒处理的事务数
  + 在事务控制器下，挂载多个取样器，想要把多个取样器合并为1个事务，**必须勾选**“Generate parent sample”
+ 性能测试中，是否要勾选“Generate parent sample”？
  + 性能测试，要先做单接口的性能测试，然后再做多接口的性能测试。
    + 一个业务场景内三个接口，先测出来哪个接口的性能最差，捕捉到整个业务场景的短板，只需要去优化时间最长的接口即可。
  + 在做多接口合并的时候，需要勾选。
  + 在性能测试中， 需要先用单个取样器，做出某个接口的性能测试指标，然后再出多个接口的性能指标， 然后再使用事务控制器，勾选Generate parent sample，做出业务的性能指标， 把所有 业务都出来，再合并，做出整个系统的性能指标
    + 如果领导要你做某个业务的性能指标，哪你，需要先梳理出，这个业务所有的接口，然后对这个业务所有的接口进行性能测试，得到性能指标，然后，再使用事务控制器，合并取样器，最终才得到 业务的性能指标。
  + 真正做性能测试时，所有的监听器，都要禁用
+ 聚合报告\汇总报告
  + 在性能测试中，看聚合报告，有前提条件：
    + 1、**没有网络瓶颈**
      + 因为，在很多时候，我们在看聚合报告时，会把 **吞吐量的值**  等价为 **TPS的值**
      + 怎么判断有没有网络瓶颈?
        + 聚合报告最后两列，是 吞吐率   吞吐率 与我们的带宽是有关系， 吞吐率，是可以看出是否存在网络带宽问题？
          + 当吞吐量约接近上行和下行的数据，就表示有网络的瓶颈
        + 20Mb  100Mb
        + 1B  = 8b
        + 1Mb =  1 x 1024kb = 1024kb/8  = 128KB/s
        + 企业服务器，一般电商类的产品，也就几m带宽
        + 民用的带宽，上行较宽、下行较窄
    + 2、**并发用户数不变**
      + 负载测试时，并发用户数会随着时间变化，而变化，就不能看聚合报告。
  + 每一行：都是一种事务
  + 每一列：
    + 样本： 在过程的过程中，所有的并发用户数，在一段时间中的总请求量
      + 单独看样本，是无法知道并发用户数、 执行时长
      +  10r x 60s x pl  = 472     pl 频率=0.78  tps
    + 平均值...........最大值： 响应时间   单位是  毫秒ms
      + 90%： 所有的样本中，有90%的样本时间是小于等于这个时间的

# 20210618白板

+ 事务控制  +  聚合报告
  + jmeter中，默认一个取样器，发起一次请求就一个事务
  + 多个取样器要合并为一个事务，添加事务控制器
  + 聚合报告：
    + 1、没有网络瓶颈   吞吐量  tps
    + 2、并发用户数不变  聚合报告中的数据，是一个平均数
    + 每一行，代表一种事务
+ Critical Section Controller 临界控制器  ----比较特殊，用的少
  + 严格控制请求顺序
  + 锁名称： 默认是一个固定锁名称
    + 相当于把性能测试中的**并行**执行，强制转换为 **串行**
  + 如何让锁变成动态锁，生成多把锁？
    + 锁名称变成一个动态名称
    + global_lock_${\_\_threadNum}

+ Once Only Controller 仅一次控制器
  + 仅一次控制器： 意思是，**一个线程用户只执行一次**
    + 理解？
      + 并发用户是10，不管你设置循环多少次，其下挂载的取样器，每个都只会执行10次
      + 并发用户是10，不管你运行多长时间，其下挂载的取样器，每个都只会执行10次

+ 吞吐量控制器
  + 总的吞吐量
  + 控制百分比， 使用多个吞吐量控制器，使他们的之和100
  + 不推荐大家用吞吐量控制器
    +  总请求量 = 并发用户数  \*  时间 \*  频率

+ 随机控制器：
  + 随机挑选其下挂载的取样器中1个执行

+ 随机顺序控制器：
  + 其下的所有取样器都会被打乱顺序执行



+ 性能测试脚本开发：
  + 1、写测试脚本
  + 2、可能需要添加  逻辑控制器（事务控制器）
    + 如果只有一个取样器，就不需要添加事务控制
    + 事务控制器，多个取样器合并时，才用
  + 3、性能场景设计
    + 普通
    + 负载
    + 压力
    + 混合
    + 面向目标
    + 波浪.....

+ 其他协议脚本开发
  + http协议
  + soap、jdbc、websocket、mq、dubbo

+ 现在的项目，一般，不会局限于一种协议

soap =  http协议 + xml传输数据---有效数据率比较低

```xml
<?xml version="1.0" encoding="utf-8"?>
<soap:Envelope xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/">
  <soap:Body>
    <getSupportCityDataset xmlns="http://WebXml.com.cn/">
      <theRegionCode>31123</theRegionCode>
    </getSupportCityDataset>
  </soap:Body>
</soap:Envelope>
```



```json
{"theRegionCode":"31123"}
```

soap  协议接口



混合场景： 不同并发用户数，使用不同接口发起请求

	A: 30  -----吞吐量控制
	
	B: 20
	
	C: 10

https://blog.csdn.net/u011072936/article/details/125835979?ops_request_misc=&request_id=&biz_id=102&utm_term=jmeter%205.6%20%20soap&utm_medium=distribute.pc_search_result.none-task-blog-2~all~sobaiduweb~default-1-125835979.142^v92^chatsearchT0_1&spm=1018.2226.3001.4187



# 20210621白板

+ jdbc： java调用数据库的语言

![img](https://img-blog.csdnimg.cn/18b35d92dbfe49efbdf5ba566bf0ff27.png)

+ 调用数据库时，需要使用jar  + 数据库信息
+ jmeter是用java开发，可以直接执行java代码

+ 找jar包？

+ kyj项目，数据库的版本，mysql5.7
+ 服务maven的仓库，搜索 数据库，官方地址：https://mvnrepository.com/
+ 找到你需要的版本，点击版本
  + Files  jar  下载这个jar包
  + 此时，就下载到你本地了
+ 把下载的jar包，放到jmeter的**lib**文件夹中
+ 重启jmeter，此时，jmeter就可以写jdbc请求了
  + 有这个jar包之后，jmeter可以发起jdbc请求，没有这个jar包，也有这个jdbc取样器，但是，不能发起请求。
  + 第三方‘库’ 

+ 注意：
  + mysql版本8 与 mysql版本5.7 jar有差异吗？
    + 现在企业中，用的mysql数据库，一般都是 mysql5 和mysql8  5的版本，一般都是5.7.x
    + mysql5的版本，jar包，可以选择大于等于你数据库版本的任意jar包。
    + mysql8版本，那么你选择的jar包，要大于等于你版本号，一般情况，选择版本号相同的
    + mysql8与mysql5的驱动class不一样

+ 写脚本
  + 添加 配置元件 > JDBC Connection Configuration
    + 填写数据库的：ip、port、dbname、user、password、pool、字符集 、驱动类.....
    
    + variable name for created pool： 自定义一个线程池变量名
      + 规则： 字母、数字、下划线
      
    + database Connection Configuration
      + database URL:  填写数据库的ip、端口、dbname， 但是，不同的数据库URL地址写法不一样
        + mysql：  jdbc:mysql://serverip:port/dbname
        
          ![img](https://img-blog.csdnimg.cn/acdd1b2829e84a41ac62fd4d4de87931.png)
        
        + MYSQL数据库默认端口：3306,  我们kyj项目用数据库端口是：3337
        
      + jdbc driver class：  不同的数据库，这个驱动class不一样
        + mysql: com.mysql.jdbc.Driver  **只适用于mysql5版本**，是选择
          + mysql8是手写：com.mysql.cj.jdbc.Driver
        
      + username
      
      + password
      
      + ![image-20230816201615581](/Users/z.m/Library/Application Support/typora-user-images/image-20230816201615581.png)
      
      + 排坑日记：记得删掉空格![img]()
    
  + jdbc request： 
    + 连接池： 一定要与JDBC Connection Configuration中配置的连接池名称要一致
    + ![img](https://img-blog.csdnimg.cn/d1e8cb8f1f7d4a07b008df3064ef34d8.png)
    + sql query：



+ sql分页：  page\*2   page\*3
  + limit 1,10   limit 11,10  limit 21,10
  + limit ${}变量占位符, 10
  +  limit 5 offset 1



先写脚本，再讲注意事项

1、 连接池，一定要写，一定要与 JDBC Connection Configuration 配置一致

2、jmeter中，写sql可以不写分号， 不要想着在一个sql query中写多个sql，要写多个sql就用多个jdbc request。 默认也是不支持一个sql query中写多个sql

3、sql语句，CRUD

	query type： 
	select statement 、 
	update statement、 
	prepared select statement 、 
	prepared update statement

带有 prepared开头，是脚本中，可以带有参数

+ sql中带参数的写法： 两种
  + 直接在sql中，进行变量引用  ${var}  但是不推荐
  + 用 ? 变量占位符   ====推荐 ,防止SQL注入![image-20230816214038518](/Users/z.m/Library/Application Support/typora-user-images/image-20230816214038518.png)

variable：变量名

variable names：

result variable name

多个参数之间，只想取中间的可以使用,分割

sqlite：关系型数据库， 内存关系数据库，不需要安装、也可以没有账号密码，它的存储文件file   .db

jmeter运行过程中，动态数据，写入sqlite数据库， 生成测试数据库 csv、txt
